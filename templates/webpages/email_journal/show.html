[% USE HTML %][% USE L %][% USE LxERP %][%- USE P -%] [% USE T8 %]

 <h1>[% FORM.title %]</h1>

[%- INCLUDE 'common/flash.html' %]

<div class="tabwidget" id="email_tabs">
  <ul>
    <li><a href="#ui-tabs-basic-data">[% 'Basic Data' | $T8 %]</a></li>
    <li><a href="controller.pl?action=RecordLinks/ajax_list&object_model=EmailJournal&object_id=[% HTML.url(SELF.entry.id) %]">[% 'Linked Records' | $T8 %]</a></li>
  </ul>

[% PROCESS "email_journal/tabs/basic_data.html" %]
</div> <!-- /.tabwidget -->

 [% SET attachments = SELF.entry.attachments_sorted %]
  <h2>[% LxERP.t8("Attachments") %]</h2>
 [% IF attachments.size %]

  <table id="email_journal_details" class="email_journal_details">
   <thead>
    <tr>
     <th>[% LxERP.t8("Attachment name") %]</th>
     <th>[% LxERP.t8("MIME type") %]</th>
     <th>[% LxERP.t8("Size") %]</th>
    </tr>
   </thead>

   <tbody>
    [% FOREACH attachment = attachments %]
     <tr class="listrow">
      <td>[% L.link(SELF.url_for(action="download_attachment", id=attachment.id), attachment.name) %]</td>
      <td>[% HTML.escape(attachment.mime_type) %]</td>
      <td>[% HTML.escape(LxERP.format_amount(attachment.content.length, 0)) %]</td>
     </tr>
    [% END %]
   </tbody>
  </table>
 [% END %]

[% IF SELF.entry.status == 'imported' || SELF.entry.status == 'record_imported' %]
<form method="post" action="controller.pl" id="record_action_form">
  [% L.hidden_tag('email_journal_id', SELF.entry.id) %]

  <table> <tr>
    <td>
      [% L.select_tag('attachment_id',
           attachments, value_key='id', title_key='name',
           default = attachments.0.id,
           with_empty=1, empty_value='', empty_title=LxERP.t8("No attachment"),
           'data-title'=LxERP.t8("Attachment"), class="wi-normal",
           onchange='kivi.EmailJournal.update_attachment_preview();'
           )
        %]
    </td>

    <td>
      [% L.select_tag('customer_vendor_selection',
         [
           {value => "customer", name => LxERP.t8("Sales")},
           {value => "vendor",   name => LxERP.t8("Purchase")},
         ],
         default = CV_TYPE_FOUND,
         value_key='value', title_key='name',
         class="wi-verysmall",
         onchange='kivi.EmailJournal.update_customer_vendor_selection();'
         ) %]
    </td>

    <td>
      [% FOREACH cv_option = [
           ['customer', 'Customer', 1],
           ['vendor',   'Vendor',   0],
           ] %]
      [% SET cv_type        = cv_option.0 %]
      [% SET cv_name        = cv_option.1 %]
      [% SET cv_is_cusotmer = cv_option.2 %]
      <div
        id="[% cv_type _ "_div" %]" class="col"
        style=[% IF cv_type == CV_TYPE_FOUND %] "display:block" [% ELSE %] "display:none" [% END %]
        >
        [% P.customer_vendor.picker(
             cv_type _ "_id",
             CUSTOMER_VENDOR.is_customer == cv_is_cusotmer ? CUSTOMER_VENDOR : undef,
             type=cv_type, class="wi-normal", placeholder=LxERP.t8(cv_name)
             ) %]
      </div>
    [% END %]
    </td>

    <td>
      [% L.select_tag('action_selection',
         [
           {value => "workflow",   name => LxERP.t8("Create from Workflow")},
           {value => "linking",    name => LxERP.t8("Linking to Record")},
           {value => "create_new", name => LxERP.t8("Create new")},
         ],
         value_key='value', title_key='name',
         class="wi-normal",
         onchange='kivi.EmailJournal.update_action_selection();'
         ) %]
    </td>

    <td>
      [% FOREACH customer_vendor = ['customer', 'vendor'] %]
      <div id="[% customer_vendor _ "_record_types_div" %]" class="col"
        style=[% IF customer_vendor == CV_TYPE_FOUND %] "display:block" [% ELSE %] "display:none" [% END %]
        >

        [%
          SET options = [];
          FOREACH record_info = RECORD_TYPES_WITH_INFO;
            IF (record_info.customervendor == customer_vendor);
              options.push({value => record_info.record_type, name => record_info.text});
            END;
          END;
        %]
      [% L.select_tag(customer_vendor _ '_record_type_selection',
         options,
         value_key='value', title_key='name',
         with_empty=1, empty_value='', empty_title=LxERP.t8("Select record type"),
         class="wi-normal",
         onchange='kivi.EmailJournal.update_record_type_selection("' _ customer_vendor _ '");'
         ) %]
      </div>
      [% END %]
    </td>

    <td>
      <div id="record_type_div" class="col" style="display:block">
        [% FOREACH record_info = RECORD_TYPES_WITH_INFO %]
        <div id="[% record_info.record_type _ "_div" %]" class="col record_type" style="display:none">
          [% L.input_tag(record_info.record_type _ "_id", '',
               style="color:black", class="wi-normal",
               placeholder=record_info.record_type _ " id") %]
        </div>
        [% END %]
        <div id="record_type_placeholder_div" class="col record_type" style="display:block">
          [% L.input_tag('cv_placeholder', '',
               style="color:black", class="wi-normal", disabled=1,
               ) %]
        </div>
      </div>
      <div id="no_record_type_div" class="col" style="display:none">
        [% L.input_tag('cv_placeholder', '',
             style="color:black", class="wi-normal", disabled=1,
             ) %]
      </div>
    </td>

    <td>
      [% L.button_tag('kivi.EmailJournal.apply_action_with_attachment();', LxERP.t8('Apply with Attachment')) %]
    </td>
  </tr> </table>
</form>

<!-- kivi.EmailJournal.update_attachment_preview -->
<div id="attachment_preview"></div>
[% END %]
