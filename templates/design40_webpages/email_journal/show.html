[% USE HTML %]
[% USE L %]
[% USE LxERP %]
[% USE P %]
[% USE T8 %]

[% BLOCK filter_toggle_panel # can't change name %]
<table id="email_journal_details" class="tbl-horizontal">
  <tbody>
    <tr>
      <th>[% 'From' | $T8 %]</th>
      <td>[% L.input_tag('from',  SELF.entry.from, style="color:black", class="wi-verywide", disabled=1) %]</td>
    </tr>
    <tr>
      <th>[% 'Recipients' | $T8 %]</th>
      <td>[% L.input_tag('recipients', SELF.entry.recipients, style="color:black", class="wi-verywide", disabled=1) %]</td>
    </tr>
    <tr>
      <th>[% 'Subject' | $T8 %]</th>
      <td>[% L.input_tag('subject', SELF.entry.subject, style="color:black", class="wi-verywide", disabled=1) %]</td>
    </tr>
    <tr>
      <th>[% 'Sent on' | $T8 %]</th>
      <td>[% L.input_tag('sent_on', SELF.entry.sent_on.to_lxoffice("precision" => "second"), style="color:black", class="wi-verywide", disabled=1) %]</td>
    </tr>
    <tr>
      <th>[% 'Status' | $T8 %]</th>
      <td>[% L.input_tag('status', P.email_journal.entry_status(SELF.entry), style="color:black", class="wi-verywide", disabled=1) %]</td>
    </tr>
    <tr>
      <th>[% 'Extended status' | $T8 %]</th>
      <td>
        [% L.textarea_tag('extended_status', SELF.entry.extended_status, wrap="soft", style="color:black; height:25px", class="wi-verywide", disabled=1) %]
      </td>
    </tr>
    <tr>
      <th>[% 'Headers' | $T8 %]</th>
      <td>
        [% L.textarea_tag('headers', HTML.escape(SELF.entry.headers), wrap="soft", style="color:black; height:25px", class="wi-verywide", disabled=1) %]
      </td>
    </tr>
    <tr>
      <th>[% 'Body' | $T8 %]</th>
      <td>
        [% IF SELF.entry.headers.match('(?i)content-type:.*text/html') %]
          <div style="border:1px solid black;">
          [% P.restricted_html(SELF.entry.body) %]
          </div>
        [% ELSE %]
          [% L.textarea_tag('body', SELF.entry.body, wrap="soft", style="color:black; height:200px", class="wi-verywide", disabled=1) %]
        [% END %]
      </td>
    </tr>
  </tbody>
</table>
[% END %]



<h1>[% FORM.title %]</h1>

[% INCLUDE 'common/flash.html' %]

<div class="wrapper" id="wrapper-0">

<div class="wrapper">
  [%
    display_status = 'open';
    button_closed  = LxERP.t8('Show Email');
    button_open    = LxERP.t8('Hide Email');
    INCLUDE 'common/toggle_panel.html';
  %]
</div><!-- /.wrapper -->


[% SET attachments = SELF.entry.attachments_sorted %]

<div class="wrapper input-panel" style="vertical-align:top;" id="wrapper-2">

[% IF attachments.size %]
<table id="email_journal_details" class="tbl-list">
  <caption>[% 'Attachments' | $T8 %]</caption>
  <thead>
    <tr>
      <th>[% 'Attachment name' | $T8 %]</th>
      <th>[% 'MIME type' | $T8 %]</th>
      <th>[% 'Size' | $T8 %]</th>
    </tr>
  </thead>
  <tbody>
    [% FOREACH attachment = attachments %]
    <tr>
      <td>[% L.link(SELF.url_for(action="download_attachment", id=attachment.id), attachment.name) %]</td>
      <td>[% HTML.escape(attachment.mime_type) %]</td>
      <td>[% HTML.escape(LxERP.format_amount(attachment.content.length, 0)) %]</td>
    </tr>
    [% END %]
  </tbody>
</table>
[% END %]

[% IF SELF.entry.status == 'imported' || SELF.entry.status == 'record_imported' %]
<form method="post" action="controller.pl" id="record_action_form">
  [% L.hidden_tag('email_journal_id', SELF.entry.id) %]

  <div id="action_div" class="input-panel">

    <div class="col">
    [% L.select_tag('attachment_id',
         attachments, value_key='id', title_key='name',
         default = attachments.0.id,
         with_empty=1, empty_value='', empty_title=LxERP.t8("No attachment"),
         'data-title'=LxERP.t8("Attachment"), class="wi-normal",
         onchange='kivi.EmailJournal.update_attachment_preview();'
         )
      %]
    </div>

    <div class="col">
    [% L.select_tag('record_action',
       # id has to start with customer_ or vendor_ for picker selection
       [
         [ LxERP.t8("Linking"), [
           {id => "link_sales_quotation",           name => LxERP.t8("Link to sales quotation")},
           {id => "link_sales_order_intake",        name => LxERP.t8("Link to sales order intake")},
           {id => "link_sales_order",               name => LxERP.t8("Link to sales order")},
           {id => "link_request_quotation",         name => LxERP.t8("Link to request quotation")},
           {id => "link_purchase_quotation_intake", name => LxERP.t8("Link to purchase quotation intake")},
           {id => "link_purchase_order",            name => LxERP.t8("Link to purchase order")},

         ] ],
         [ LxERP.t8("Sales"), [
             {id => "customer_sales_order",  name => LxERP.t8("Create sales order")},
             {id => "customer_sales_order_intake",  name => LxERP.t8("Create sales order intake")},
             {id => "customer_sales_quotation",  name => LxERP.t8("Create sales quotation")},
         ] ],
         [ LxERP.t8("Purchase"), [
             {id => "vendor_purchase_order", name => LxERP.t8("Create purchase order")},
             {id => "vendor_purchase_quotation_intake", name => LxERP.t8("Create purchase quotation intake")},
             {id => "vendor_request_quotation", name => LxERP.t8("Create request quotation")},

         ] ],
       ],
       value_key='id', title_key='name',
       with_empty=1, empty_value='', empty_title=LxERP.t8("No action"),
       with_optgroups=1,
       class="wi-normal",
       onchange='kivi.EmailJournal.update_extra_div_selection();'
       ) %]
    </div>

    [% FOREACH cv_type_name = [['customer', 'Customer'], ['vendor', 'Vendor']] %]
    [% SET cv_type = cv_type_name.0 %]
    [% SET cv_name = cv_type_name.1 %]
    <div id="[% cv_type _ "_div" %]" class="col" style="display:none">
      [% P.customer_vendor.picker(
           cv_type _ "_id", SELF.find_cv_from_email(cv_type, SELF.entry),
           type=cv_type, class="wi-normal", placeholder=LxERP.t8(cv_name)
           ) %]
    </div>
    [% END %]
    [% FOREACH record_type  = [
         'sales_quotation', 'sales_order_intake', 'sales_order',
         'request_quotation', 'purchase_quotation_intake', 'purchase_order'
         ] %]
    <div id="[% "link_" _ record_type _ "_div" %]" class="col" style="display:none">
      [% L.input_tag(record_type _ "_id", '',
           style="color:black", class="wi-normal",
           placeholder=record_type _ " id") %]
    </div>
    [% END %]
    <div id="placeholder_div" class="col" style="display:block">
      [% L.input_tag('cv_placeholder', '',
           style="color:black", class="wi-normal", disabled=1,
           placeholder=LxERP.t8("Select action first"),
           ) %]
    </div>

    <div class="col">
      [% L.button_tag('kivi.EmailJournal.apply_record_action();', LxERP.t8('Apply with Attachment')) %]
    </div>
  </div> <!-- action_div -->
</form>

<!-- kivi.EmailJournal.update_attachment_preview -->
<div id="attachment_preview"></div>
[% END %]

</div> <!-- wrapper-2 -->

</div> <!-- wrapper-0 -->
